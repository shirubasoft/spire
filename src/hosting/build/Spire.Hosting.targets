<Project>

  <!-- Auto-install/update the spire CLI tool when opted in -->
  <Target Name="_EnsureSpireCliInstalled"
          BeforeTargets="_CheckSpireCliAvailability"
          Condition="'$(SpireAutoInstallCli)' == 'true' AND '$(SkipSharedResourceResolution)' != 'true'">
    <Message Text="Spire: Ensuring the 'spire' CLI tool is installed/up-to-date..."
             Importance="high" />
    <Exec Command="dotnet tool install -g spire.cli"
          IgnoreExitCode="true"
          StandardOutputImportance="low"
          StandardErrorImportance="low">
      <Output TaskParameter="ExitCode" PropertyName="_SpireToolInstallExitCode" />
    </Exec>
    <Warning Condition="'$(_SpireToolInstallExitCode)' != '0'"
             Text="Spire: Auto-install of 'spire' CLI tool failed (exit code $(_SpireToolInstallExitCode)). The build will continue, but may fail if the tool is not available." />
  </Target>

  <!-- Check that the spire CLI is available -->
  <Target Name="_CheckSpireCliAvailability"
          BeforeTargets="_ImportSharedResources"
          Condition="'$(SkipSharedResourceResolution)' != 'true'">
    <Exec Command="spire --version" ConsoleToMsBuild="true" IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="_SpireCliExitCode" />
    </Exec>
    <Error Condition="'$(_SpireCliExitCode)' != '0'"
           Text="The 'spire' CLI tool is required but was not found on PATH. Install with: dotnet tool install -g Spire.Cli" />
  </Target>

  <!-- Import shared resources from .aspire/settings.json into the global config -->
  <Target Name="_ImportSharedResources"
          BeforeTargets="_ForwardSharedResourcesToGenerator"
          Condition="'$(SkipSharedResourceResolution)' != 'true'">
    <Exec Command="spire resource import" />
  </Target>

  <!-- Query the CLI for resolved resources and forward to the source generator -->
  <Target Name="_ForwardSharedResourcesToGenerator"
          BeforeTargets="CoreCompile"
          Condition="'$(SkipSharedResourceResolution)' != 'true'">
    <PropertyGroup>
      <_SharedResourceJsonPath>$(IntermediateOutputPath)SharedResources.g.json</_SharedResourceJsonPath>
    </PropertyGroup>

    <Exec Command="spire resource list &gt; &quot;$(_SharedResourceJsonPath)&quot;" />

    <ItemGroup>
      <AdditionalFiles Include="$(_SharedResourceJsonPath)" />
    </ItemGroup>
  </Target>

</Project>
