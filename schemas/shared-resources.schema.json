{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://raw.githubusercontent.com/shirubasoft/spire/main/schemas/shared-resources.schema.json",
  "$defs": {
    "containerModeSettings": {
      "type": "object",
      "properties": {
        "imageName": {
          "type": "string",
          "description": "The container image name.",
          "pattern": "^[a-z0-9][a-z0-9._/-]*$"
        },
        "imageRegistry": {
          "type": "string",
          "description": "The container image registry.",
          "pattern": "^[a-z0-9][a-z0-9._-]*(:[0-9]+)?(/[a-z0-9._-]+)*$"
        },
        "imageTag": {
          "type": "string",
          "description": "The container image tag (e.g., 'latest', branch name, or commit hash).",
          "pattern": "^[a-z0-9][a-z0-9._-]*$"
        },
        "buildCommand": {
          "type": "string",
          "description": "The command used to build the container image.",
          "minLength": 1
        },
        "buildWorkingDirectory": {
          "type": "string",
          "description": "The working directory for the build command.",
          "minLength": 1
        }
      },
      "required": ["imageName", "imageRegistry", "imageTag", "buildCommand", "buildWorkingDirectory"],
      "additionalProperties": false
    },
    "projectModeSettings": {
      "type": "object",
      "properties": {
        "projectPath": {
          "type": "string",
          "description": "The path to the project file (.csproj).",
          "minLength": 1
        }
      },
      "required": ["projectPath"],
      "additionalProperties": false
    },
    "gitRepositorySettings": {
      "type": "object",
      "properties": {
        "url": {
          "type": "string",
          "description": "The repository URL.",
          "format": "uri"
        },
        "defaultBranch": {
          "type": "string",
          "description": "The default branch name.",
          "default": "main",
          "pattern": "^[^\\s]+$"
        }
      },
      "required": ["url"],
      "additionalProperties": false
    },
    "resourceBase": {
      "type": "object",
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["container", "project"],
          "description": "The default execution mode."
        },
        "gitRepository": {
          "$ref": "#/$defs/gitRepositorySettings"
        }
      },
      "required": ["mode"]
    },
    "absolutePath": {
      "type": "string",
      "minLength": 1,
      "pattern": "^(/|[A-Za-z]:[\\\\/])"
    },
    "relativePath": {
      "type": "string",
      "minLength": 1,
      "pattern": "^(?!/|[A-Za-z]:[\\\\/])"
    },
    "globalResource": {
      "allOf": [
        { "$ref": "#/$defs/resourceBase" },
        {
          "properties": {
            "mode": true,
            "gitRepository": true,
            "containerMode": {
              "allOf": [
                { "$ref": "#/$defs/containerModeSettings" },
                {
                  "properties": {
                    "buildWorkingDirectory": { "$ref": "#/$defs/absolutePath" }
                  }
                }
              ]
            },
            "projectMode": {
              "allOf": [
                { "$ref": "#/$defs/projectModeSettings" },
                {
                  "properties": {
                    "projectPath": { "$ref": "#/$defs/absolutePath" }
                  }
                }
              ]
            }
          },
          "additionalProperties": false
        }
      ]
    },
    "repositoryResource": {
      "allOf": [
        { "$ref": "#/$defs/resourceBase" },
        {
          "properties": {
            "mode": true,
            "gitRepository": true,
            "containerMode": {
              "allOf": [
                { "$ref": "#/$defs/containerModeSettings" },
                {
                  "properties": {
                    "buildWorkingDirectory": { "$ref": "#/$defs/relativePath" }
                  }
                }
              ]
            },
            "projectMode": {
              "allOf": [
                { "$ref": "#/$defs/projectModeSettings" },
                {
                  "properties": {
                    "projectPath": { "$ref": "#/$defs/relativePath" }
                  }
                }
              ]
            }
          },
          "additionalProperties": false
        }
      ]
    },
    "externalResource": {
      "type": "object",
      "properties": {
        "url": {
          "type": "string",
          "description": "The URL of the external Git repository.",
          "format": "uri"
        },
        "branch": {
          "type": "string",
          "description": "The branch to use.",
          "default": "main",
          "pattern": "^[^\\s]+$"
        }
      },
      "required": ["url"],
      "additionalProperties": false
    },
    "globalConfig": {
      "type": "object",
      "description": "Global shared resources configuration (~/.aspire/spire/aspire-shared-resources.json). All paths are absolute.",
      "properties": {
        "$schema": {
          "type": "string"
        },
        "resources": {
          "type": "object",
          "propertyNames": {
            "pattern": "^[a-z0-9][a-z0-9-]*$"
          },
          "additionalProperties": {
            "$ref": "#/$defs/globalResource"
          },
          "description": "A map of resource ID to resource definition."
        }
      },
      "required": ["resources"],
      "additionalProperties": false
    },
    "repositoryConfig": {
      "type": "object",
      "description": "Repository-scoped shared resources configuration. All paths are relative to the repository root.",
      "properties": {
        "resources": {
          "type": "object",
          "propertyNames": {
            "pattern": "^[a-z0-9][a-z0-9-]*$"
          },
          "additionalProperties": {
            "$ref": "#/$defs/repositoryResource"
          },
          "description": "A map of resource ID to resource definition."
        },
        "externalResources": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/externalResource"
          },
          "description": "External Git repositories whose shared-resources.json files are imported."
        }
      },
      "required": ["resources"],
      "additionalProperties": false
    },
    "aspireSettings": {
      "type": "object",
      "description": "Aspire AppHost settings (.aspire/settings.json) extended with shared resource definitions. Paths in sharedResources are relative to the repository root.",
      "properties": {
        "$schema": {
          "type": "string"
        },
        "appHostPath": {
          "type": "string",
          "description": "The path to the AppHost project file."
        },
        "sharedResources": {
          "$ref": "#/$defs/repositoryConfig"
        }
      },
      "required": ["appHostPath"],
      "additionalProperties": true
    }
  }
}
